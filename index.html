<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EP Strategie-Planer</title>
    
    <link rel="icon" href="https://fav.farm/üé¢">
    <link rel="apple-touch-icon" href="https://fav.farm/üé¢">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        :root {
            --bg: #0b0f1a; --card-bg: rgba(30, 41, 59, 0.7);
            --accent: #60a5fa; --text-main: #f8fafc; --text-dim: #94a3b8;
            --up: #f43f5e; --down: #10b981; --gold: #facc15;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 12px; }
        header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 15px; position: sticky; top: 0; background: rgba(11,15,26,0.9); backdrop-filter: blur(15px); z-index: 100;
        }
        .btn-icon { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; }
        
        .land-section { margin-top: 25px; }
        .land-title { font-size: 0.75em; font-weight: 800; text-transform: uppercase; color: var(--accent); letter-spacing: 1.5px; margin-bottom: 12px; padding-left: 5px; border-left: 3px solid var(--accent); }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(165px, 1fr)); gap: 15px; }
        
        .card { 
            background: var(--card-bg); border-radius: 20px; padding: 16px; border: 1px solid rgba(255,255,255,0.05);
            backdrop-filter: blur(10px); display: flex; flex-direction: column;
        }
        .ride-name { font-size: 0.85em; font-weight: 600; min-height: 2.6em; line-height: 1.3; margin-bottom: 10px; }
        
        .row { display: flex; justify-content: space-between; align-items: center; }
        .wait-time { font-size: 2.2em; font-weight: 800; letter-spacing: -1px; }
        .unit { font-size: 0.35em; color: var(--text-dim); margin-left: 2px; }

        .badge-row { display: flex; gap: 5px; margin-bottom: 8px; flex-wrap: wrap; }
        .badge { font-size: 0.6em; font-weight: 800; padding: 3px 7px; border-radius: 6px; text-transform: uppercase; }
        .badge-sr { background: #6366f1; color: white; }
        .badge-deal { background: var(--gold); color: #000; }
        
        .dist-info { font-size: 0.65em; color: var(--accent); font-weight: bold; margin-top: 8px; display: flex; align-items: center; gap: 4px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 8px; }

        #settings-modal { display: none; position: fixed; inset: 0; background: #000; z-index: 200; padding: 25px; overflow-y: auto; }
        .spinning { animation: rotate 0.8s ease-in-out; }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<header>
    <button class="btn-icon" onclick="openSettings()">‚öôÔ∏è</button>
    <div style="text-align:center"><div style="font-weight:900; letter-spacing:-1px">EP STRATEGIE</div><div id="gps-status" style="font-size:0.5em; color:var(--text-dim)">GPS inaktiv</div></div>
    <button id="refresh-btn" class="btn-icon" onclick="refresh()">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
    </button>
</header>

<div id="main-content"></div>

<div id="settings-modal">
    <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom:20px">
        <h2>Favoriten</h2>
        <button class="btn-icon" onclick="closeSettings()">‚úï</button>
    </div>
    <div id="settings-list"></div>
</div>

<script>
    const QT_ID = "51";
    const PROXY = "https://api.allorigins.win/get?url=";
    
    // Koordinaten der Top-Attraktionen f√ºr die Distanzberechnung
    const RIDE_PROPS = {
        "WODAN - Timburcoaster": { sr: true, lat: 48.2625, lon: 7.7183, best: 30 },
        "blue fire Megacoaster": { sr: true, lat: 48.2618, lon: 7.7205, best: 25 },
        "Silver Star": { sr: true, lat: 48.2691, lon: 7.7218, best: 20 },
        "Arthur": { sr: true, lat: 48.2675, lon: 7.7166, best: 30 },
        "Voletarium": { sr: true, lat: 48.2690, lon: 7.7235, best: 20 },
        "Euro-Mir": { sr: true, lat: 48.2655, lon: 7.7210, best: 20 },
        "Piraten in Batavia": { sr: false, lat: 48.2665, lon: 7.7202, best: 15 },
        "Eurostat CanCan Coaster": { sr: false, lat: 48.2675, lon: 7.7212, best: 25 }
    };

    let parkData = {};
    let userPos = null;
    let selectedIds = JSON.parse(localStorage.getItem('ep_favs')) || [];

    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(pos => {
            userPos = { lat: pos.coords.latitude, lon: pos.coords.longitude };
            document.getElementById('gps-status').innerText = "Standort aktiv";
            render();
        }, (err) => {
            document.getElementById('gps-status').innerText = "GPS Zugriff verweigert";
        }, { enableHighAccuracy: true });
    }

    async function refresh() {
        const btn = document.getElementById('refresh-btn');
        btn.classList.add('spinning');
        try {
            const url = `https://queue-times.com/parks/${QT_ID}/queue_times.json`;
            const resp = await fetch(PROXY + encodeURIComponent(url));
            const json = await resp.json();
            const data = JSON.parse(json.contents);

            parkData = {};
            data.lands.forEach(land => {
                parkData[land.name] = land.rides.map(r => ({
                    ...r, 
                    props: RIDE_PROPS[r.name] || { sr: false, best: 10, lat: 48.266, lon: 7.721 } // Fallback Mitte Park
                }));
            });
            render();
        } catch (e) { console.error(e); }
        setTimeout(() => btn.classList.remove('spinning'), 800);
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
        if (!lat1 || !lat2) return null;
        const R = 6371; // km
        const dLat = (lat2-lat1) * Math.PI/180;
        const dLon = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        const d = R * c;
        return d; // in km
    }

    function render() {
        const container = document.getElementById('main-content');
        container.innerHTML = "";

        for (let landName in parkData) {
            const rides = parkData[landName].filter(r => selectedIds.length === 0 || selectedIds.includes(r.id));
            if (rides.length === 0) continue;

            const landHtml = `
                <div class="land-section">
                    <div class="land-title">${landName}</div>
                    <div class="grid">${rides.map(r => renderCard(r)).join('')}</div>
                </div>
            `;
            container.innerHTML += landHtml;
        }
    }

    function renderCard(r) {
        const isDeal = r.is_open && r.wait_time <= r.props.best;
        const distKm = userPos && r.props.lat ? calculateDistance(userPos.lat, userPos.lon, r.props.lat, r.props.lon) : null;
        
        let distText = "";
        if (distKm !== null) {
            if (distKm < 1) distText = Math.round(distKm * 1000) + " m";
            else distText = distKm.toFixed(1) + " km";
        }

        let color = r.is_open ? (r.wait_time > 45 ? 'var(--up)' : (r.wait_time > 15 ? 'var(--accent)' : 'var(--down)')) : 'var(--text-dim)';
        
        return `
            <div class="card" style="${isDeal ? 'border: 1px solid var(--gold)' : ''}">
                <div class="badge-row">
                    ${r.props.sr ? '<span class="badge badge-sr">Single Rider</span>' : ''}
                    ${isDeal ? '<span class="badge badge-deal">Top Deal</span>' : ''}
                </div>
                <div class="ride-name">${r.name}</div>
                <div class="row">
                    <div class="wait-time" style="color:${color}">
                        ${r.is_open ? r.wait_time : '‚úï'}<span class="unit">${r.is_open ? 'MIN' : ''}</span>
                    </div>
                </div>
                ${distText ? `
                    <div class="dist-info">
                        <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                        ${distText}
                    </div>` : ''}
            </div>
        `;
    }

    function openSettings() {
        const list = document.getElementById('settings-list');
        list.innerHTML = "";
        let flatRides = [];
        for(let l in parkData) flatRides = [...flatRides, ...parkData[l]];
        
        flatRides.sort((a,b) => a.name.localeCompare(b.name)).forEach(r => {
            list.innerHTML += `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid #222">
                    <span style="font-size:0.85em; max-width: 80%">${r.name}</span>
                    <input type="checkbox" ${selectedIds.includes(r.id) ? 'checked' : ''} onchange="toggle(${r.id})">
                </div>
            `;
        });
        document.getElementById('settings-modal').style.display = "block";
    }

    function toggle(id) {
        if (selectedIds.includes(id)) selectedIds = selectedIds.filter(i => i !== id);
        else selectedIds.push(id);
        localStorage.setItem('ep_favs', JSON.stringify(selectedIds));
        render();
    }

    function closeSettings() { document.getElementById('settings-modal').style.display = "none"; }
    
    refresh();
    setInterval(refresh, 180000);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EP Strategie Pro</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0b1120">
    <link rel="icon" href="https://fav.farm/üé¢">
    <link rel="apple-touch-icon" href="https://fav.farm/üé¢">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        :root {
            --bg: #0b1120; --card-bg: rgba(30, 41, 59, 0.8);
            --accent: #38bdf8; --text-main: #f8fafc; --text-dim: #94a3b8;
            --up: #ef4444; --down: #22c55e; --gold: #fbbf24;
        }
        
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 0; overflow: hidden; }
        
        header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px 15px; height: 75px; background: rgba(11,17,32,0.9); 
            backdrop-filter: blur(15px); z-index: 1000; border-bottom: 1px solid rgba(255,255,255,0.1); 
            box-sizing: border-box;
        }

        .sync-info { text-align: center; flex: 1; }
        #last-sync-time { font-size: 0.6em; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }
        #park-name { font-size: 0.9em; font-weight: 900; letter-spacing: -0.5px; }

        .toggle-group { display: flex; background: rgba(255,255,255,0.05); border-radius: 12px; padding: 3px; }
        .toggle-btn { border: none; background: none; color: var(--text-dim); padding: 8px 12px; font-size: 0.8em; font-weight: 700; border-radius: 10px; cursor: pointer; }
        .toggle-btn.active { background: var(--accent); color: white; }

        .btn-icon { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; transition: 0.2s; }
        
        /* Toast Feedback */
        #toast { 
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); 
            background: var(--accent); color: white; padding: 10px 20px; border-radius: 12px; 
            font-size: 0.85em; font-weight: 700; z-index: 5000; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        #toast.show { transform: translateX(-50%) translateY(0); }

        #list-view { padding: 15px; height: calc(100vh - 75px); overflow-y: auto; box-sizing: border-box; }
        #map-view { width: 100vw; height: calc(100vh - 75px); display: none; position: relative; }
        .map-overlay-btn { position: absolute; right: 20px; bottom: 30px; z-index: 1001; background: var(--accent); color: white; border: none; border-radius: 50%; width: 55px; height: 55px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; font-size: 1.5em; }

        .land-section { margin-top: 20px; }
        .land-title { font-size: 0.75em; font-weight: 800; text-transform: uppercase; color: var(--accent); margin-bottom: 12px; border-left: 4px solid var(--accent); padding-left: 10px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .card { background: var(--card-bg); border-radius: 20px; padding: 16px; border: 1px solid rgba(255,255,255,0.05); position: relative; }
        
        .alert-toggle { position: absolute; top: 15px; right: 15px; font-size: 1.3em; cursor: pointer; opacity: 0.2; }
        .alert-toggle.enabled { opacity: 1; color: var(--gold); }

        .ride-name { font-size: 0.85em; font-weight: 600; min-height: 2.8em; margin-bottom: 8px; padding-right: 25px; }
        .wait-time { font-size: 2.3em; font-weight: 900; }

        .ride-marker { width: 34px; height: 34px; border-radius: 50%; border: 2.5px solid white; color: white; font-weight: 900; font-size: 13px; display: flex; align-items: center; justify-content: center; }

        #settings-modal { display: none; position: fixed; inset: 0; background: #000; z-index: 3000; padding: 25px; overflow-y: auto; }
        .spinning { animation: rotate 0.8s linear infinite; }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="toast">Daten aktualisiert!</div>

<header>
    <button class="btn-icon" onclick="openSettings()">‚öôÔ∏è</button>
    <div class="sync-info">
        <div id="park-name">EUROPA-PARK</div>
        <div id="last-sync-time">Synchronisiere...</div>
    </div>
    <div class="toggle-group">
        <button id="btn-list" class="toggle-btn active" onclick="switchView('list')">Liste</button>
        <button id="btn-map" class="toggle-btn" onclick="switchView('map')">Karte</button>
    </div>
    <button id="refresh-btn" class="btn-icon" onclick="manualRefresh()">
        <svg id="refresh-svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
    </button>
</header>

<div id="list-view"><div id="main-content"></div></div>
<div id="map-view"><button class="map-overlay-btn" onclick="resetMap()">üéØ</button></div>

<div id="settings-modal">
    <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom:25px;">
        <h2>Einstellungen</h2>
        <button class="btn-icon" onclick="closeSettings()">‚úï</button>
    </div>
    <div id="settings-list"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    const QT_ID = "51";
    const PROXY = "https://api.allorigins.win/get?url=";
    const CENTER = [48.266, 7.721];

    const RIDE_PROPS = {
        "WODAN - Timburcoaster": { lat: 48.2625, lon: 7.7183, best: 30 },
        "blue fire Megacoaster": { lat: 48.2618, lon: 7.7205, best: 25 },
        "Silver Star": { lat: 48.2691, lon: 7.7218, best: 20 },
        "Arthur": { lat: 48.2675, lon: 7.7166, best: 30 },
        "Voletarium": { lat: 48.2690, lon: 7.7235, best: 25 },
        "Euro-Mir": { lat: 48.2655, lon: 7.7210, best: 25 },
        "Piraten in Batavia": { lat: 48.2665, lon: 7.7202, best: 15 },
        "Eurosat - CanCan Coaster": { lat: 48.2673, lon: 7.7213, best: 25 }
    };

    let parkData = {};
    let selectedIds = JSON.parse(localStorage.getItem('ep_favs')) || [];
    let enabledAlerts = JSON.parse(localStorage.getItem('ep_alerts')) || [];
    let alertedRides = new Set();
    let map, rideMarkers = [];

    let lastDataHash = ""; 
    let lastSyncTimestamp = 0;

    // --- Feedback System ---
    function showToast(text, color = "var(--accent)") {
        const t = document.getElementById('toast');
        t.innerText = text;
        t.style.background = color;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2500);
    }

    function updateSyncLabel() {
        if (lastSyncTimestamp === 0) return;
        const diff = Math.round((Date.now() - lastSyncTimestamp) / 1000);
        const label = document.getElementById('last-sync-time');
        if (diff < 60) label.innerText = `Vor ${diff}s aktualisiert`;
        else label.innerText = `Vor ${Math.floor(diff/60)}m aktualisiert`;
    }

    // --- API Logic ---
    async function manualRefresh() {
        const svg = document.getElementById('refresh-svg');
        svg.classList.add('spinning');
        await refresh(true);
        svg.classList.remove('spinning');
    }

    async function refresh(isManual = false) {
        try {
            const url = `https://queue-times.com/parks/${QT_ID}/queue_times.json`;
            const resp = await fetch(PROXY + encodeURIComponent(url + "?t=" + Date.now()));
            const json = await resp.json();
            const data = JSON.parse(json.contents);

            // Pr√ºfen, ob Daten wirklich neu sind (via JSON String Vergleich)
            const currentHash = JSON.stringify(data.lands);
            
            if (currentHash === lastDataHash) {
                if (isManual) showToast("Daten bereits aktuell", "var(--text-dim)");
            } else {
                lastDataHash = currentHash;
                lastSyncTimestamp = Date.now();
                
                parkData = {};
                data.lands.forEach(land => {
                    parkData[land.name] = land.rides.map(r => ({
                        ...r, props: RIDE_PROPS[r.name] || { lat: null, lon: null, best: 10 }
                    }));
                });

                checkAlerts();
                renderList();
                if (map) updateMapMarkers();
                if (isManual) showToast("Daten erfolgreich geladen!");
            }
        } catch (e) { 
            console.error(e);
            if (isManual) showToast("Fehler beim Abrufen!", "var(--up)");
        }
    }

    // --- Vibration & Alarm ---
    function sendSilentNotification(title, message) {
        if ("Notification" in window && Notification.permission === "granted") {
            navigator.serviceWorker.ready.then(reg => {
                reg.showNotification(title, {
                    body: message,
                    icon: "https://fav.farm/üé¢",
                    vibrate: [300, 100, 300],
                    silent: true
                });
            });
        }
    }

    function checkAlerts() {
        for (let land in parkData) {
            parkData[land].forEach(r => {
                if (enabledAlerts.includes(r.id) && r.is_open && r.wait_time <= 20) {
                    if (!alertedRides.has(r.id)) {
                        sendSilentNotification("Strategie-Alarm!", `${r.name}: nur noch ${r.wait_time} min.`);
                        alertedRides.add(r.id);
                    }
                } else if (r.wait_time > 20) {
                    alertedRides.delete(r.id);
                }
            });
        }
    }

    // --- UI & Map ---
    function switchView(view) {
        document.getElementById('list-view').style.display = view === 'list' ? 'block' : 'none';
        document.getElementById('map-view').style.display = view === 'map' ? 'block' : 'none';
        document.getElementById('btn-list').classList.toggle('active', view === 'list');
        document.getElementById('btn-map').classList.toggle('active', view === 'map');
        if (view === 'map') {
            if (!map) {
                map = L.map('map-view', { zoomControl: false }).setView(CENTER, 17);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
            }
            setTimeout(() => { map.invalidateSize(); updateMapMarkers(); }, 200);
        }
    }

    function resetMap() { if (map) map.flyTo(CENTER, 17); }

    function renderList() {
        const container = document.getElementById('main-content'); container.innerHTML = "";
        for (let landName in parkData) {
            const rides = parkData[landName].filter(r => selectedIds.length === 0 || selectedIds.includes(r.id));
            if (rides.length === 0) continue;
            container.innerHTML += `<div class="land-section"><div class="land-title">${landName}</div><div class="grid">${rides.map(r => `
                <div class="card">
                    <div class="alert-toggle ${enabledAlerts.includes(r.id) ? 'enabled' : ''}" onclick="toggleAlert(${r.id})">üîî</div>
                    <div class="ride-name">${r.name}</div>
                    <div class="wait-time" style="color:${r.is_open ? (r.wait_time > 40 ? 'var(--up)' : 'var(--accent)') : 'var(--text-dim)'}">
                        ${r.is_open ? r.wait_time : '‚úï'}<span style="font-size:0.4em">MIN</span>
                    </div>
                </div>`).join('')}</div></div>`;
        }
    }

    function updateMapMarkers() {
        if (!map) return;
        rideMarkers.forEach(m => map.removeLayer(m)); rideMarkers = [];
        for (let land in parkData) {
            parkData[land].forEach(r => {
                if (selectedIds.length > 0 && !selectedIds.includes(r.id)) return;
                if (!r.props.lat) return;
                const color = r.is_open ? (r.wait_time > 45 ? '#ef4444' : (r.wait_time > 15 ? '#38bdf8' : '#22c55e')) : '#4b5563';
                const icon = L.divIcon({
                    className: 'custom-icon',
                    html: `<div class="ride-marker" style="background:${color}; ${enabledAlerts.includes(r.id) ? 'border-color:var(--gold)' : ''}">${r.is_open ? r.wait_time : '‚úï'}</div>`,
                    iconSize: [34, 34]
                });
                rideMarkers.push(L.marker([r.props.lat, r.props.lon], { icon }).addTo(map).bindPopup(r.name));
            });
        }
    }

    function toggleAlert(id) {
        if (enabledAlerts.includes(id)) enabledAlerts = enabledAlerts.filter(i => i !== id);
        else { enabledAlerts.push(id); showToast("Alarm f√ºr <= 20 min aktiv!"); }
        localStorage.setItem('ep_alerts', JSON.stringify(enabledAlerts));
        renderList();
    }

    function openSettings() {
        const list = document.getElementById('settings-list'); list.innerHTML = "";
        let flat = []; for(let l in parkData) flat = [...flat, ...parkData[l]];
        flat.sort((a,b)=>a.name.localeCompare(b.name)).forEach(r => {
            list.innerHTML += `<div style="display:flex; justify-content:space-between; padding:15px; border-bottom:1px solid #222">
                <span>${r.name}</span>
                <input type="checkbox" style="width:22px; height:22px" ${selectedIds.includes(r.id) ? 'checked' : ''} onchange="toggleFav(${r.id})">
            </div>`;
        });
        document.getElementById('settings-modal').style.display = "block";
    }

    function toggleFav(id) {
        if (selectedIds.includes(id)) selectedIds = selectedIds.filter(i => i !== id); else selectedIds.push(id);
        localStorage.setItem('ep_favs', JSON.stringify(selectedIds)); renderList();
    }

    function closeSettings() { document.getElementById('settings-modal').style.display = "none"; }
    
    // --- Start ---
    if ('serviceWorker' in navigator) {
        const sw = 'self.addEventListener("notificationclick", e => { e.notification.close(); e.waitUntil(clients.openWindow("/")); });';
        navigator.serviceWorker.register(URL.createObjectURL(new Blob([sw], {type: 'text/javascript'})));
    }

    refresh();
    setInterval(refresh, 60000); // Automatischer Sync jede Minute
    setInterval(updateSyncLabel, 5000); // Anzeige im Header alle 5s aktualisieren
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EP Strategie Ultra (Compact Graph)</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0b1120">
    <link rel="icon" href="https://fav.farm/üé¢">
    <link rel="apple-touch-icon" href="https://fav.farm/üé¢">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        :root {
            --bg: #0b1120;
            --card-bg: rgba(30, 41, 59, 0.95);
            --accent: #38bdf8;
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --up: #ef4444;
            --down: #22c55e;
            --gold: #fbbf24;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0; padding: 0;
            overflow: hidden;
            user-select: none;
        }

        /* Header */
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 15px; height: 75px;
            background: rgba(11, 17, 32, 0.95); backdrop-filter: blur(15px);
            z-index: 1000; border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-sizing: border-box;
        }

        .sync-info { text-align: center; flex: 1; }
        #last-sync-time { font-size: 0.55em; color: var(--text-dim); text-transform: uppercase; }
        #proxy-label { font-size: 0.5em; display: block; margin-top: 2px; font-weight: bold; }
        #park-name { font-size: 0.9em; font-weight: 900; letter-spacing: -0.5px; }

        .toggle-group { display: flex; background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 3px; margin: 0 10px; }
        .toggle-btn { border: none; background: none; color: var(--text-dim); padding: 8px 12px; font-size: 0.8em; font-weight: 700; border-radius: 10px; cursor: pointer; transition: 0.2s; }
        .toggle-btn.active { background: var(--accent); color: white; }

        .btn-icon { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; }

        /* Views */
        #list-view { padding: 15px; height: calc(100vh - 75px); overflow-y: auto; box-sizing: border-box; }
        #map-view { width: 100vw; height: calc(100vh - 75px); display: none; position: relative; }
        
        .map-overlay-btn { position: absolute; right: 20px; bottom: 30px; z-index: 1001; background: var(--accent); color: white; border: none; border-radius: 50%; width: 55px; height: 55px; font-size: 1.5em; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }

        /* Leaflet Popup Styles */
        .leaflet-popup-content-wrapper { border-radius: 12px; font-family: sans-serif; }
        .leaflet-popup-content b { font-size: 1.1em; color: #333; }
        .nav-link { display: inline-block; margin-top: 8px; padding: 6px 12px; background: #4285F4; color: white !important; text-decoration: none; border-radius: 6px; font-weight: bold; font-size: 0.9em; }

        /* Cards */
        .land-section { margin-top: 20px; }
        .land-title { font-size: 0.75em; font-weight: 800; text-transform: uppercase; color: var(--accent); margin-bottom: 12px; border-left: 4px solid var(--accent); padding-left: 10px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        
        .card { 
            background: var(--card-bg); border-radius: 20px; padding: 16px; 
            border: 1px solid rgba(255, 255, 255, 0.05); position: relative; 
            min-height: 100px;
            backdrop-filter: blur(10px);
        }
        
        .settings-gear { position: absolute; top: 15px; right: 15px; font-size: 1.2em; cursor: pointer; opacity: 0.4; transition: 0.3s; z-index: 10; }
        .settings-gear.active { opacity: 1; color: var(--gold); text-shadow: 0 0 10px rgba(251, 191, 36, 0.5); }
        .settings-label { position: absolute; top: 18px; right: 45px; font-size: 0.6em; color: var(--gold); font-weight: bold; }

        .ride-name { font-size: 0.85em; font-weight: 600; min-height: 2.8em; margin-bottom: 8px; padding-right: 35px; line-height: 1.3; }
        .wait-time { font-size: 2.3em; font-weight: 900; }
        .unit { font-size: 0.4em; color: var(--text-dim); margin-left: 2px; }

        .badge { font-size: 0.6em; font-weight: 800; padding: 3px 7px; border-radius: 6px; text-transform: uppercase; margin-bottom: 8px; display: inline-block; }
        .badge-sr { background: #6366f1; color: white; margin-right: 5px; }
        .badge-deal { background: var(--gold); color: #000; }
        .dist-tag { font-size: 0.6em; color: var(--accent); margin-top: 5px; }

        /* GRAPH STYLES - Kompakt */
        .history-graph {
            position: absolute; bottom: 8px; right: 8px;
            width: 75px; height: 35px; /* Wieder kleiner */
            pointer-events: none;
        }
        .graph-line { fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; filter: drop-shadow(0 0 2px rgba(0,0,0,0.5)); }
        .graph-text { font-size: 8px; fill: var(--text-dim); font-weight: bold; font-family: monospace; }

        .ride-marker { width: 34px; height: 34px; border-radius: 50%; border: 2.5px solid white; color: white; font-weight: 900; font-size: 13px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--accent); color: white; padding: 12px 25px; border-radius: 15px; font-size: 0.85em; z-index: 5000; transition: transform 0.4s; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #toast.show { transform: translateX(-50%) translateY(0); }

        /* Modals */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 3000; padding: 25px; overflow-y: auto; backdrop-filter: blur(5px); }
        .modal-content { background: #1e293b; padding: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); margin-top: 5vh; }
        .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #1e293b; }
        
        .input-group { margin: 20px 0; }
        .input-group label { display: block; margin-bottom: 10px; color: var(--text-dim); font-size: 0.9em; }
        .input-group input { width: 100%; padding: 12px; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 10px; font-size: 1em; box-sizing: border-box; }
        
        .save-btn { width: 100%; padding: 15px; background: var(--gold); color: black; border: none; border-radius: 12px; font-weight: bold; font-size: 1em; cursor: pointer; margin-bottom: 10px; }
        .delete-btn { width: 100%; padding: 15px; background: transparent; color: var(--up); border: 1px solid var(--up); border-radius: 12px; font-weight: bold; font-size: 1em; cursor: pointer; }

        /* GitHub Config */
        .gh-config { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-bottom: 25px; border: 1px solid rgba(255,255,255,0.1); }
        .gh-config h3 { margin-top: 0; color: var(--accent); font-size: 0.9em; text-transform: uppercase; letter-spacing: 1px; }

        .spinning { animation: rotate 0.8s linear infinite; }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="toast">Synchronisiert!</div>

<header>
    <button class="btn-icon" onclick="openSettings()">‚öôÔ∏è</button>
    <div class="sync-info">
        <div id="park-name">EUROPA-PARK</div>
        <div id="last-sync-time">Warte...</div>
        <span id="proxy-label" style="font-size:0.5em;">Multi-Proxy</span>
    </div>
    <div class="toggle-group">
        <button id="btn-list" class="toggle-btn active" onclick="switchView('list')">Liste</button>
        <button id="btn-map" class="toggle-btn" onclick="switchView('map')">Karte</button>
    </div>
    <button id="refresh-btn" class="btn-icon" onclick="manualRefresh()">
        <svg id="refresh-svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
    </button>
</header>

<div id="list-view"><div id="main-content"></div></div>
<div id="map-view"><button class="map-overlay-btn" onclick="resetMap()">üéØ</button></div>

<!-- Settings Modal -->
<div id="settings-modal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom:25px;">
            <h2>Einstellungen</h2>
            <button class="btn-icon" onclick="closeSettings()">‚úï</button>
        </div>
        
        <div class="gh-config" id="gh-config-box">
            <h3>GitHub Server Steuerung</h3>
            <button id="monitoring-toggle-btn" class="btn-icon" style="width:100%; background:var(--text-dim); font-weight:bold; margin-bottom:15px; height:50px; color:white; border:none;" onclick="toggleGitHubWorkflow()">
                ‚ö™ Status wird geladen...
            </button>
            <details style="color:var(--text-dim); font-size:0.8em;">
                <summary>Verbindungsdaten bearbeiten</summary>
                <div class="input-group"><label>GitHub User:</label><input type="text" id="gh-user" placeholder="z.B. DeinName"></div>
                <div class="input-group"><label>Repo Name:</label><input type="text" id="gh-repo" placeholder="z.B. europapark"></div>
                <div class="input-group"><label>Token (Repo Scope):</label><input type="password" id="gh-token" placeholder="ghp_..."></div>
                <button class="save-btn" style="background:#334155; margin-top:5px;" onclick="saveGitHubConfig()">Speichern</button>
            </details>
        </div>
        
        <button id="push-enable-btn" style="width:100%; padding:15px; border-radius:12px; background:var(--gold); color:black; border:0; font-weight:bold; margin-bottom:20px; display:none;">
            üîî Push-Nachrichten aktivieren
        </button>

        <div id="settings-list"></div>
        
        <hr style="border:0; border-top:1px solid #222; margin: 25px 0;">
        <div style="display:flex; gap:10px;">
            <button class="btn-icon" style="flex:1; background:var(--accent); font-weight:bold;" onclick="testNotification()">üì≥ Vibration</button>
            <button id="push-test-btn" class="btn-icon" style="flex:1; background:var(--gold); color:black; font-weight:bold;" onclick="requestPushTest()">üöÄ Cloud Test</button>
        </div>
    </div>
</div>

<!-- Ride Alert Modal -->
<div id="ride-alert-modal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom:20px;">
            <h2 id="alert-ride-name">Ride Name</h2>
            <button class="btn-icon" onclick="closeRideModal()">‚úï</button>
        </div>
        <div class="input-group">
            <label>Alarm wenn weniger als:</label>
            <input type="number" id="alert-threshold" placeholder="20" inputmode="numeric">
            <p style="font-size:0.7em; color:var(--text-dim); margin-top:5px;">Minuten Wartezeit</p>
        </div>
        <button class="save-btn" onclick="saveRideAlert()">üíæ Speichern & Aktivieren</button>
        <button class="delete-btn" onclick="deleteRideAlert()">Alarm l√∂schen</button>
    </div>
</div>

<!-- Firebase & Push Module -->
<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
    import { getFirestore, doc, setDoc, getDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    import { getMessaging, getToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-messaging.js';

    // DEINE FIREBASE CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyAf4nF5XItLd6CC3sdQ_ePEYduaSTdXjGI",
      authDomain: "ep-pro-c768d.firebaseapp.com",
      projectId: "ep-pro-c768d",
      storageBucket: "ep-pro-c768d.firebasestorage.app",
      messagingSenderId: "678617107748",
      appId: "1:678617107748:web:11c73addee5db76f26f7b1",
      measurementId: "G-1MBSKD8ZH4"
    };
    const VAPID_KEY = "BFp2JrM56fRBkdVd6izSz7slAIP513-LhE3LgV049a8-9QVxzpIUjsqFU6bgNTQOjFPZR8yXfYymRGad0IbvPKo";
    const APP_ID_PATH = 'ep-pro-strategie';
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const messaging = getMessaging(app);

    let currentUser = null;

    signInAnonymously(auth).catch(err => console.error("Auth Fehler:", err));

    onAuthStateChanged(auth, (user) => {
        currentUser = user;
        if (user) {
            if (Notification.permission !== 'granted') {
                document.getElementById('push-enable-btn').style.display = 'block';
            }
            const alertRef = doc(db, 'artifacts', APP_ID_PATH, 'users', user.uid, 'settings', 'alerts');
            onSnapshot(alertRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    window.enabledAlerts = data.alerts || {};
                    if(Array.isArray(window.enabledAlerts)) window.enabledAlerts = {};
                    localStorage.setItem('ep_alerts', JSON.stringify(window.enabledAlerts));
                    if(window.renderList) window.renderList();
                }
            });
        }
    });

    window.syncAlertsToCloud = async (alerts) => {
        if (!currentUser) return;
        const jobRef = doc(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'alertJobs', currentUser.uid);
        await setDoc(jobRef, { 
            userId: currentUser.uid, 
            alerts: alerts, 
            active: Object.keys(alerts).length > 0 
        }, { merge: true });
        
        await setDoc(doc(db, 'artifacts', APP_ID_PATH, 'users', currentUser.uid, 'settings', 'alerts'), { alerts: alerts }, { merge: true });
    };

    window.requestPushTest = async () => {
        if (!currentUser) return alert("Noch nicht eingeloggt.");
        const btn = document.getElementById('push-test-btn');
        btn.innerText = "‚è≥ Sende...";
        btn.disabled = true;

        try {
            let reg = await navigator.serviceWorker.getRegistration();
            if(!reg) reg = await navigator.serviceWorker.register(getSWPath(), { scope: './' });

            const token = await getToken(messaging, { vapidKey: VAPID_KEY, serviceWorkerRegistration: reg });
            if (!token) throw new Error("Kein Token. Klicke erst 'Push aktivieren'.");
            
            const jobRef = doc(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'alertJobs', currentUser.uid);
            await setDoc(jobRef, { 
                fcmToken: token, 
                testRequested: true,
                lastUpdate: Date.now()
            }, { merge: true });

            showToast("Test angefordert!");
            btn.innerText = "‚úÖ Fertig";
            setTimeout(() => { btn.disabled = false; btn.innerText = "üöÄ Cloud Push-Test"; }, 5000);

        } catch (err) {
            console.error(err);
            btn.disabled = false;
            btn.innerText = "‚ùå Fehler";
            alert("Fehler: " + err.message);
        }
    };

    window.getSWPath = () => {
        let path = window.location.pathname;
        if (!path.endsWith('/')) path = path.substring(0, path.lastIndexOf('/') + 1);
        return path + 'firebase-messaging-sw.js';
    }

    document.getElementById('push-enable-btn').onclick = async () => {
        try {
            const permission = await Notification.requestPermission();
            if (permission !== 'granted') return alert("Bitte Benachrichtigungen erlauben.");
            const reg = await navigator.serviceWorker.register(getSWPath(), { scope: './' });
            const token = await getToken(messaging, { vapidKey: VAPID_KEY, serviceWorkerRegistration: reg });
            if (token && currentUser) {
                const jobRef = doc(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'alertJobs', currentUser.uid);
                await setDoc(jobRef, { fcmToken: token }, { merge: true });
                showToast("Push aktiviert!");
                document.getElementById('push-enable-btn').style.display = 'none';
            }
        } catch (err) { console.error("Push Fehler:", err); }
    };

    window.fetchHistory = async () => {
        try {
            const historyRef = doc(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'history_rolling', 'main');
            const snap = await getDoc(historyRef);
            if (snap.exists()) {
                const data = snap.data();
                if (data.points) {
                    window.historyPoints = data.points;
                    window.updateGraphs();
                }
            }
        } catch (e) { console.log("History fetch failed", e); }
    };
</script>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const QT_URL = "https://queue-times.com/parks/51/queue_times.json";
    const CENTER = [48.266, 7.721];
    const PROXIES = [
        { name: "Cloud-B (Fast)", url: u => `https://corsproxy.io/?${encodeURIComponent(u)}`, wrap: false },
        { name: "Cloud-A", url: u => `https://api.allorigins.win/get?url=${encodeURIComponent(u)}`, wrap: true }
    ];

    // RIDE LISTE
    const RIDE_PROPS = {
        "WODAN - Timburcoaster": { sr: true, lat: 48.2614, lon: 7.7192, best: 35 },
        "blue fire Megacoaster": { sr: true, lat: 48.2624, lon: 7.7185, best: 30 },
        "Silver Star": { sr: true, lat: 48.2678, lon: 7.7202, best: 25 },
        "Arthur": { sr: true, lat: 48.2639, lon: 7.7237, best: 35 },
        "Voletarium": { sr: true, lat: 48.2689, lon: 7.7225, best: 25 },
        "Euro-Mir": { sr: true, lat: 48.2654, lon: 7.7201, best: 25 },
        "Eurosat - CanCan Coaster": { sr: false, lat: 48.2674, lon: 7.7208, best: 25 },
        "Piraten in Batavia": { sr: false, lat: 48.2636, lon: 7.7197, best: 15 },
        "Matterhorn-Blitz": { sr: false, lat: 48.2669, lon: 7.7204, best: 35 },
        "Poseidon": { sr: false, lat: 48.2645, lon: 7.7215, best: 25 },
        "Atlantica SuperSplash": { sr: false, lat: 48.2612, lon: 7.7205, best: 20 },
        "Schweizer Bobbahn": { sr: false, lat: 48.2660, lon: 7.7222, best: 20 },
        "Tiroler Wildwasserbahn": { sr: false, lat: 48.2651, lon: 7.7235, best: 20 },
        "Alpenexpress Enzian": { sr: false, lat: 48.2648, lon: 7.7232, best: 15 },
        "Pegasus - Die YoungStar Achterbahn": { lat: 48.2642, lon: 7.7210, best: 15 },
        "Fjord-Rafting": { sr: false, lat: 48.2655, lon: 7.7185, best: 30 },
        "Snorri Touren": { sr: false, lat: 48.2662, lon: 7.7195, best: 20 },
        "Vindjammer": { lat: 48.2660, lon: 7.7190, best: 10 },
        "Geisterschloss": { lat: 48.2685, lon: 7.7230, best: 10 },
        "Piccolo Mondo": { lat: 48.2688, lon: 7.7232, best: 5 },
        "Volo da Vinci": { lat: 48.2682, lon: 7.7238, best: 20 },
        "Euro-Tower": { lat: 48.2668, lon: 7.7215, best: 10 },
        "Jungfrau-Gletscherflieger": { lat: 48.2658, lon: 7.7225, best: 10 },
        "Wiener Wellenflieger": { lat: 48.2655, lon: 7.7230, best: 10 },
        "Feria Swing": { lat: 48.2625, lon: 7.7235, best: 5 },
        "Koffiekopjes": { lat: 48.2675, lon: 7.7195, best: 10 },
        "Ba-a-a Express": { lat: 48.2685, lon: 7.7195, best: 10 }
    };

    window.enabledAlerts = JSON.parse(localStorage.getItem('ep_alerts')) || {};
    window.historyPoints = [];
    if(Array.isArray(window.enabledAlerts)) window.enabledAlerts = {};

    let parkData = {};
    let selectedIds = JSON.parse(localStorage.getItem('ep_favs')) || [];
    let userPos = null;
    let lastSync = 0;
    let map, rideMarkers = [], userMarker;
    let currentEditRideId = null;

    // --- GITHUB CONTROL ---
    let ghUser = localStorage.getItem('gh_user') || "";
    let ghRepo = localStorage.getItem('gh_repo') || "";
    let ghToken = localStorage.getItem('gh_token') || "";

    function loadGitHubConfig() {
        document.getElementById('gh-user').value = ghUser;
        document.getElementById('gh-repo').value = ghRepo;
        document.getElementById('gh-token').value = ghToken;
        if(ghUser && ghRepo && ghToken) checkWorkflowStatus();
        else document.getElementById('monitoring-toggle-btn').innerText = "‚öôÔ∏è GitHub Daten fehlen";
    }

    window.saveGitHubConfig = () => {
        ghUser = document.getElementById('gh-user').value.trim();
        ghRepo = document.getElementById('gh-repo').value.trim();
        ghToken = document.getElementById('gh-token').value.trim();
        localStorage.setItem('gh_user', ghUser);
        localStorage.setItem('gh_repo', ghRepo);
        localStorage.setItem('gh_token', ghToken);
        showToast("GitHub Daten gespeichert!");
        checkWorkflowStatus();
    };

    async function checkWorkflowStatus() {
        document.getElementById('monitoring-toggle-btn').innerText = "‚è≥ Pr√ºfe Status...";
        try {
            const resp = await fetch(`https://api.github.com/repos/${ghUser}/${ghRepo}/actions/workflows/check_waits.yml`, {
                headers: { 'Authorization': `token ${ghToken}` }
            });
            if(resp.ok) {
                const data = await resp.json();
                updateSwitchUI(data.state === 'active');
            } else {
                console.error("GH Error", resp.status);
                document.getElementById('monitoring-toggle-btn').innerText = "‚ö†Ô∏è Fehler (Token?)";
            }
        } catch(e) { console.error(e); }
    }

    window.toggleGitHubWorkflow = async () => {
        if(!ghUser || !ghRepo || !ghToken) return alert("Bitte erst GitHub Daten unten eingeben und speichern!");
        const btn = document.getElementById('monitoring-toggle-btn');
        const isCurrentlyActive = btn.innerText.includes("AN");
        const newState = isCurrentlyActive ? "disable" : "enable";
        btn.innerText = "‚è≥ Schalte um...";
        btn.disabled = true;

        try {
            const resp = await fetch(`https://api.github.com/repos/${ghUser}/${ghRepo}/actions/workflows/check_waits.yml/${newState}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${ghToken}`, 'Accept': 'application/vnd.github+json' }
            });
            if(resp.status === 204) {
                showToast(isCurrentlyActive ? "Gestoppt!" : "Gestartet!");
                updateSwitchUI(!isCurrentlyActive);
            } else { alert("Fehler beim Umschalten."); }
        } catch(e) { alert("Netzwerkfehler: " + e.message); }
        btn.disabled = false;
    };

    function updateSwitchUI(isActive) {
        const btn = document.getElementById('monitoring-toggle-btn');
        if(isActive) {
            btn.innerHTML = "üü¢ √úberwachung ist AN (Stoppen)";
            btn.style.background = "var(--down)";
            btn.style.color = "white";
        } else {
            btn.innerHTML = "üî¥ √úberwachung PAUSIERT (Starten)";
            btn.style.background = "rgba(255,255,255,0.1)";
            btn.style.color = "var(--text-dim)";
        }
    }

    // --- MAIN APP ---
    function findProps(name) {
        if (RIDE_PROPS[name]) return RIDE_PROPS[name];
        const keys = Object.keys(RIDE_PROPS);
        for (let k of keys) { if (name.includes(k) || k.includes(name)) return RIDE_PROPS[k]; }
        return { lat: 48.266, lon: 7.721, best: 10, isFallback: true };
    }

    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(pos => {
            userPos = { lat: pos.coords.latitude, lon: pos.coords.longitude };
            if(map) updateUserOnMap();
            window.renderList();
        }, null, { enableHighAccuracy: true });
    }

    function updateUserOnMap() {
        if (!map || !userPos) return;
        if (!userMarker) {
            userMarker = L.circleMarker([userPos.lat, userPos.lon], { 
                radius: 9, color: '#fff', weight: 2, fillColor: '#38bdf8', fillOpacity: 1 
            }).addTo(map).bindPopup("Dein Standort");
        } else {
            userMarker.setLatLng([userPos.lat, userPos.lon]);
        }
    }

    async function refresh(manual = false) {
        if (manual) document.getElementById('refresh-svg').classList.add('spinning');
        const label = document.getElementById('proxy-label');
        for (let p of PROXIES) {
            try {
                const resp = await fetch(p.url(QT_URL + "?cb=" + Date.now()), { signal: AbortSignal.timeout(7000) });
                let data = p.wrap ? JSON.parse((await resp.json()).contents) : await resp.json();
                if (data && data.lands) {
                    parkData = {};
                    data.lands.forEach(l => {
                        parkData[l.name] = l.rides.map(r => ({
                            ...r, props: findProps(r.name)
                        }));
                    });
                    lastSync = Date.now();
                    label.innerText = `Verbunden: ${p.name}`;
                    window.renderList();
                    if (map) updateMarkers();
                    if (manual) showToast("Daten aktuell!");
                    break;
                }
            } catch (e) { label.innerText = `${p.name} Error`; }
        }
        if(window.fetchHistory) await window.fetchHistory();
        document.getElementById('refresh-svg').classList.remove('spinning');
    }

    // --- GRAPH LOGIC ---
    function drawSparkline(data) {
        if (!data || data.length < 2) return '';
        const width = 50; const height = 30; // Kleiner
        const maxVal = Math.max(...data); 
        const minVal = Math.min(...data);
        const padding = 5; 
        const totalWidth = width + 25; // + Text

        const range = maxVal - minVal;
        const scale = range > 0 ? range : 1;

        const points = data.map((val, i) => {
            const x = (i / (data.length - 1)) * width;
            const y = (height - padding) - ((val - minVal) / scale) * (height - 2*padding);
            return `${x},${y}`;
        }).join(' ');

        const last = data[data.length-1];
        const prev = data[data.length-2];
        const color = last < prev ? 'var(--down)' : (last > prev ? 'var(--up)' : 'var(--accent)');

        return `
            <svg width="${totalWidth}" height="${height}" class="history-graph" style="overflow:visible">
                <text x="${width + 3}" y="8" class="graph-text" fill="var(--text-dim)">${maxVal}</text>
                <text x="${width + 3}" y="${height-2}" class="graph-text" fill="var(--text-dim)">${minVal}</text>
                <polyline points="${points}" class="graph-line" stroke="${color}"/>
                <circle cx="${width}" cy="${(height - padding) - ((last - minVal) / scale) * (height - 2*padding)}" r="2" fill="${color}" />
            </svg>
        `;
    }

    window.updateGraphs = () => {
        if (!window.historyPoints || window.historyPoints.length === 0) return;
        const sortedPoints = window.historyPoints.sort((a,b) => a.t - b.t);

        document.querySelectorAll('.card').forEach(card => {
            const rideId = card.getAttribute('data-ride-id');
            if (!rideId) return;
            const waitTimes = [];
            sortedPoints.forEach(p => {
                if (p.rides && p.rides[rideId] !== undefined) {
                    const w = p.rides[rideId];
                    if(w >= 0) waitTimes.push(w);
                }
            });
            const container = document.getElementById('graph-container-' + rideId);
            if (container) container.innerHTML = drawSparkline(waitTimes);
        });
    };

    window.renderList = () => {
        const container = document.getElementById('main-content');
        container.innerHTML = "";
        for (let land in parkData) {
            const rides = parkData[land].filter(r => selectedIds.length === 0 || selectedIds.includes(r.id));
            if (rides.length === 0) continue;
            container.innerHTML += `<div class="land-section"><div class="land-title">${land}</div><div class="grid">${rides.map(r => {
                const isDeal = r.is_open && r.wait_time <= r.props.best;
                const d = userPos ? calcDist(userPos.lat, userPos.lon, r.props.lat, r.props.lon) : "";
                const alertActive = window.enabledAlerts.hasOwnProperty(r.id);
                const threshold = alertActive ? window.enabledAlerts[r.id] : null;

                return `<div class="card" data-ride-id="${r.id}" style="${isDeal ? 'border-color:var(--gold)' : ''}">
                    <div class="settings-gear ${alertActive ? 'active' : ''}" onclick="openRideSettings('${r.id}', '${r.name.replace(/'/g, "\\'")}')">‚öôÔ∏è</div>
                    ${alertActive ? `<div class="settings-label">üîî < ${threshold}m</div>` : ''}
                    
                    <div>${r.props.sr ? '<span class="badge badge-sr">SR</span>' : ''}${isDeal ? '<span class="badge badge-deal">Deal</span>' : ''}</div>
                    <div class="ride-name">${r.name}</div>
                    <div class="wait-time" style="color:${r.is_open ? (r.wait_time > 40 ? 'var(--up)' : 'var(--accent)') : 'var(--text-dim)'}">${r.is_open ? r.wait_time : '‚úï'}</div>
                    ${d ? `<div class="dist-tag">üìç ${d}</div>` : ''}
                    
                    <!-- Graph Placeholder -->
                    <div id="graph-container-${r.id}"></div>
                </div>`;
            }).join('')}</div></div>`;
        }
        window.updateGraphs();
    }

    function updateMarkers() {
        if (!map) return;
        rideMarkers.forEach(m => map.removeLayer(m)); rideMarkers = [];
        for (let l in parkData) {
            parkData[l].forEach(r => {
                if (selectedIds.length > 0 && !selectedIds.includes(r.id)) return;
                if (r.props.isFallback) return; 
                
                // POPUP CONTENT: Name, Wartezeit und Google Maps Link
                const popupContent = `
                    <div style="text-align:center;">
                        <b>${r.name}</b><br>
                        Wartezeit: ${r.is_open ? r.wait_time + " min" : "Geschlossen"}<br>
                        <a href="https://www.google.com/maps/dir/?api=1&destination=${r.props.lat},${r.props.lon}" target="_blank" class="nav-link">
                            üöó Navigation starten
                        </a>
                    </div>
                `;

                const color = r.is_open ? (r.wait_time > 30 ? 'var(--up)' : (r.wait_time > 15 ? 'var(--accent)' : 'var(--down)')) : '#444';
                const icon = L.divIcon({ className: 'custom-icon', html: `<div class="ride-marker" style="background:${color}; ${r.wait_time <= r.props.best ? 'border-color:var(--gold)':''}">${r.is_open ? r.wait_time : '‚úï'}</div>`, iconSize: [34, 34] });
                rideMarkers.push(L.marker([r.props.lat, r.props.lon], {icon}).addTo(map).bindPopup(popupContent));
            });
        }
        updateUserOnMap();
    }

    // Modal & Settings
    window.openRideSettings = (id, name) => { currentEditRideId = id; document.getElementById('alert-ride-name').innerText = name; document.getElementById('alert-threshold').value = window.enabledAlerts[id] || 20; document.getElementById('ride-alert-modal').style.display = 'block'; }
    window.closeRideModal = () => { document.getElementById('ride-alert-modal').style.display = 'none'; currentEditRideId = null; }
    window.saveRideAlert = async () => { if(!currentEditRideId) return; const val = parseInt(document.getElementById('alert-threshold').value); if(isNaN(val)) return; window.enabledAlerts[currentEditRideId] = val; localStorage.setItem('ep_alerts', JSON.stringify(window.enabledAlerts)); if(window.syncAlertsToCloud) await window.syncAlertsToCloud(window.enabledAlerts); window.renderList(); closeRideModal(); showToast(`Alarm < ${val} min`); }
    window.deleteRideAlert = async () => { if(!currentEditRideId) return; delete window.enabledAlerts[currentEditRideId]; localStorage.setItem('ep_alerts', JSON.stringify(window.enabledAlerts)); if(window.syncAlertsToCloud) await window.syncAlertsToCloud(window.enabledAlerts); window.renderList(); closeRideModal(); showToast("Alarm gel√∂scht."); }

    function toggleFav(id) { if (selectedIds.includes(id)) selectedIds = selectedIds.filter(i => i !== id); else selectedIds.push(id); localStorage.setItem('ep_favs', JSON.stringify(selectedIds)); window.renderList(); }
    function switchView(v) { 
        document.getElementById('list-view').style.display = v==='list'?'block':'none'; 
        document.getElementById('map-view').style.display = v==='map'?'block':'none'; 
        document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active')); 
        document.getElementById('btn-' + v).classList.add('active'); 
        if (v==='map') { 
            if (!map) { 
                map = L.map('map-view', {zoomControl: false}).setView([48.266, 7.721], 16); 
                // MAP LAYERS
                const light = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OSM' });
                const sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '¬© Esri' });
                light.addTo(map);
                const baseMaps = { "Karte (Hell)": light, "Satellit": sat };
                L.control.layers(baseMaps).addTo(map);
            } 
            setTimeout(() => { map.invalidateSize(); updateMarkers(); updateUserOnMap(); }, 200); 
        } 
    }
    
    function calcDist(lat1, lon1, lat2, lon2) { const R = 6371; const dLat = (lat2-lat1)*Math.PI/180; const dLon = (lon2-lon1)*Math.PI/180; const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2; return (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))).toFixed(1)+"km"; }
    function openSettings() { document.getElementById('settings-modal').style.display='block'; window.renderSettings(); loadGitHubConfig(); }
    function closeSettings() { document.getElementById('settings-modal').style.display='none'; }
    window.renderSettings = () => { const list = document.getElementById('settings-list'); list.innerHTML = ""; let flat = []; for(let l in parkData) flat = [...flat, ...parkData[l]]; flat.sort((a,b)=>a.name.localeCompare(b.name)).forEach(r => { list.innerHTML += `<div class="settings-item"><span>${r.name}</span><input type="checkbox" ${selectedIds.includes(r.id)?'checked':''} onchange="toggleFav(${r.id})"></div>`; }); };
    function manualRefresh() { refresh(true); }
    function resetMap() { if(map) map.flyTo(userPos ? [userPos.lat, userPos.lon] : [48.266, 7.721], 17); }
    function showToast(m, bg) { const t=document.getElementById('toast'); t.innerText=m; if(bg) t.style.background=bg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2500); }
    function testNotification() { if ("vibrate" in navigator) navigator.vibrate([400, 100, 400]); showToast("Vibration ok!"); }

    refresh();
    setInterval(refresh, 90000);

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register(window.getSWPath());
    }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EP Strategie Pro (Push Edition)</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0b1120">
    <link rel="icon" href="https://fav.farm/üé¢">
    <link rel="apple-touch-icon" href="https://fav.farm/üé¢">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        :root {
            --bg: #0b1120; --card-bg: rgba(30, 41, 59, 0.8);
            --accent: #38bdf8; --text-main: #f8fafc; --text-dim: #94a3b8;
            --up: #ef4444; --down: #22c55e; --gold: #fbbf24;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text-main); margin: 0; padding: 0; overflow: hidden; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; height: 75px; background: rgba(11, 17, 32, 0.9); backdrop-filter: blur(15px); z-index: 1000; border-bottom: 1px solid rgba(255, 255, 255, 0.1); box-sizing: border-box; }
        .sync-info { text-align: center; flex: 1; }
        #last-sync-time { font-size: 0.55em; color: var(--text-dim); text-transform: uppercase; }
        #park-name { font-size: 0.9em; font-weight: 900; }
        .toggle-group { display: flex; background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 3px; margin: 0 10px; }
        .toggle-btn { border: none; background: none; color: var(--text-dim); padding: 8px 12px; font-size: 0.8em; font-weight: 700; border-radius: 10px; cursor: pointer; }
        .toggle-btn.active { background: var(--accent); color: white; }
        .btn-icon { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; color: white; cursor: pointer; }
        #list-view { padding: 15px; height: calc(100vh - 75px); overflow-y: auto; box-sizing: border-box; }
        #map-view { width: 100vw; height: calc(100vh - 75px); display: none; position: relative; }
        .land-section { margin-top: 20px; }
        .land-title { font-size: 0.75em; font-weight: 800; color: var(--accent); margin-bottom: 12px; border-left: 4px solid var(--accent); padding-left: 10px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .card { background: var(--card-bg); border-radius: 20px; padding: 16px; border: 1px solid rgba(255, 255, 255, 0.05); position: relative; }
        .alert-toggle { position: absolute; top: 15px; right: 15px; font-size: 1.3em; cursor: pointer; opacity: 0.2; }
        .alert-toggle.enabled { opacity: 1; color: var(--gold); }
        .ride-name { font-size: 0.85em; font-weight: 600; min-height: 2.8em; margin-bottom: 8px; padding-right: 25px; line-height: 1.3; }
        .wait-time { font-size: 2.3em; font-weight: 900; }
        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--accent); color: white; padding: 12px 25px; border-radius: 15px; font-size: 0.85em; z-index: 5000; transition: transform 0.4s; }
        #toast.show { transform: translateX(-50%) translateY(0); }
        #settings-modal { display: none; position: fixed; inset: 0; background: #000; z-index: 3000; padding: 25px; overflow-y: auto; }
        .spinning { animation: rotate 0.8s linear infinite; }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #1e293b; }
    </style>
</head>
<body>

<div id="toast">Nachrichten aktiv!</div>

<header>
    <button class="btn-icon" onclick="openSettings()">‚öôÔ∏è</button>
    <div class="sync-info">
        <div id="park-name">EUROPA-PARK</div>
        <div id="last-sync-time">Synchronisiere...</div>
    </div>
    <div class="toggle-group">
        <button id="btn-list" class="toggle-btn active" onclick="switchView('list')">Liste</button>
        <button id="btn-map" class="toggle-btn" onclick="switchView('map')">Karte</button>
    </div>
    <button id="refresh-btn" class="btn-icon" onclick="manualRefresh()">
        <svg id="refresh-svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
    </button>
</header>

<div id="list-view"><div id="main-content"></div></div>
<div id="map-view"></div>

<div id="settings-modal">
    <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom:25px;">
        <h2>Favoriten & Push</h2>
        <button class="btn-icon" onclick="closeSettings()">‚úï</button>
    </div>
    <button id="push-enable-btn" style="width:100%; padding:15px; border-radius:12px; background:var(--gold); color:black; border:0; font-weight:bold; margin-bottom:20px;">
        üîî Push-Nachrichten aktivieren
    </button>
    <div id="settings-list"></div>
</div>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
    import { getFirestore, doc, setDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    import { getMessaging, getToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-messaging.js';

    // Firebase Config aus Umgebungsvariablen
    const firebaseConfig = JSON.parse(__firebase_config);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    
    // HIER DEINEN VAPID KEY EINSETZEN (aus Projekttsettings -> Cloud Messaging)
    const VAPID_KEY = "BFp2JrM56fRBkdVd6izSz7slAIP513-LhE3LgV049a8-9QVxzpIUjsqFU6bgNTQOjFPZR8yXfYymRGad0IbvPKo";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const messaging = getMessaging(app);

    let currentUser = null;

    // Authentifizierung und Cloud-Sync
    signInAnonymously(auth);
    onAuthStateChanged(auth, (user) => {
        currentUser = user;
        if (user) {
            const alertRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'alerts');
            onSnapshot(alertRef, (docSnap) => {
                if (docSnap.exists()) {
                    window.enabledAlerts = docSnap.data().active || [];
                    localStorage.setItem('ep_alerts', JSON.stringify(window.enabledAlerts));
                    if(window.renderList) window.renderList();
                }
            });
        }
    });

    // Push-Dienst registrieren
    document.getElementById('push-enable-btn').onclick = async () => {
        try {
            // Berechtigung anfragen
            const permission = await Notification.requestPermission();
            if (permission !== 'granted') {
                alert("Benachrichtigungen wurden abgelehnt.");
                return;
            }

            const token = await getToken(messaging, { vapidKey: VAPID_KEY });
            if (token && currentUser) {
                // Token speichern
                const tokenRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'settings', 'pushToken');
                await setDoc(tokenRef, { token: token, lastUpdate: Date.now() });
                
                const jobRef = doc(db, 'artifacts', appId, 'public', 'data', 'alertJobs', currentUser.uid);
                await setDoc(jobRef, { fcmToken: token }, { merge: true });

                showToast("Push-Nachrichten aktiv!");
                document.getElementById('push-enable-btn').style.display = 'none';
            }
        } catch (err) {
            console.error("Push Error", err);
            alert("Fehler beim Aktivieren. Pr√ºfe die Konsole.");
        }
    };

    window.syncAlertsToCloud = async (alerts) => {
        if (!currentUser) return;
        const jobRef = doc(db, 'artifacts', appId, 'public', 'data', 'alertJobs', currentUser.uid);
        await setDoc(jobRef, { userId: currentUser.uid, alerts: alerts, active: alerts.length > 0 }, { merge: true });
    };
</script>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const QT_URL = "https://queue-times.com/parks/51/queue_times.json";
    
    const RIDE_PROPS = {
        "WODAN - Timburcoaster": { best: 35 },
        "blue fire Megacoaster": { best: 30 },
        "Silver Star": { best: 25 },
        "Arthur": { best: 35 },
        "Voletarium": { best: 25 },
        "Euro-Mir": { best: 25 },
        "Piraten in Batavia": { best: 15 },
        "Eurosat - CanCan Coaster": { best: 25 }
    };

    window.enabledAlerts = JSON.parse(localStorage.getItem('ep_alerts')) || [];
    let parkData = {};
    let selectedIds = JSON.parse(localStorage.getItem('ep_favs')) || [];
    let lastSync = 0;

    async function refresh() {
        try {
            const resp = await fetch(`https://corsproxy.io/?${encodeURIComponent(QT_URL + "?cb=" + Date.now())}`);
            const data = await resp.json();
            if (data && data.lands) {
                parkData = {};
                data.lands.forEach(l => {
                    parkData[l.name] = l.rides.map(r => ({ ...r, props: RIDE_PROPS[r.name] || { best: 10 } }));
                });
                lastSync = Date.now();
                renderList();
            }
        } catch (e) { console.error(e); }
    }

    async function manualRefresh() {
        const svg = document.getElementById('refresh-svg');
        svg.classList.add('spinning');
        await refresh();
        setTimeout(() => svg.classList.remove('spinning'), 1000);
    }

    async function toggleAlert(id) {
        if (window.enabledAlerts.includes(id)) window.enabledAlerts = window.enabledAlerts.filter(i => i !== id);
        else window.enabledAlerts.push(id);
        
        localStorage.setItem('ep_alerts', JSON.stringify(window.enabledAlerts));
        if (window.syncAlertsToCloud) await window.syncAlertsToCloud(window.enabledAlerts);
        renderList();
    }

    window.renderList = () => {
        const container = document.getElementById('main-content');
        container.innerHTML = "";
        for (let land in parkData) {
            const rides = parkData[land].filter(r => selectedIds.length === 0 || selectedIds.includes(r.id));
            if (rides.length === 0) continue;
            container.innerHTML += `<div class="land-section"><div class="land-title">${land}</div><div class="grid">${rides.map(r => `
                <div class="card">
                    <div class="alert-toggle ${window.enabledAlerts.includes(r.id) ? 'enabled' : ''}" onclick="toggleAlert(${r.id})">üîî</div>
                    <div class="ride-name">${r.name}</div>
                    <div class="wait-time" style="color:${r.is_open ? (r.wait_time > 40 ? 'var(--up)' : 'var(--accent)') : 'var(--text-dim)'}">${r.is_open ? r.wait_time : '‚úï'}<span style="font-size:0.4em">MIN</span></div>
                </div>`).join('')}</div></div>`;
        }
    }

    function switchView(v) {
        document.getElementById('list-view').style.display = v==='list'?'block':'none';
        document.getElementById('map-view').style.display = v==='map'?'block':'none';
        document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + v).classList.add('active');
    }

    function openSettings() { document.getElementById('settings-modal').style.display='block'; window.renderSettings(); }
    function closeSettings() { document.getElementById('settings-modal').style.display='none'; }
    
    window.renderSettings = () => {
        const list = document.getElementById('settings-list'); list.innerHTML = "";
        let flat = []; for(let l in parkData) flat = [...flat, ...parkData[l]];
        flat.sort((a,b)=>a.name.localeCompare(b.name)).forEach(r => {
            list.innerHTML += `<div class="settings-item"><span>${r.name}</span><input type="checkbox" ${selectedIds.includes(r.id)?'checked':''} onchange="toggleFav(${r.id})"></div>`;
        });
    }

    function toggleFav(id) {
        if (selectedIds.includes(id)) selectedIds = selectedIds.filter(i => i !== id);
        else selectedIds.push(id);
        localStorage.setItem('ep_favs', JSON.stringify(selectedIds));
        renderList();
    }

    function showToast(m) {
        const t = document.getElementById('toast');
        t.innerText = m; t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2500);
    }

    refresh();
    setInterval(() => {
        if (lastSync > 0) {
            const diff = Math.round((Date.now()-lastSync)/1000);
            document.getElementById('last-sync-time').innerText = "Stand: " + diff + "s alt";
        }
    }, 5000);
</script>
</body>
</html>

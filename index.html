<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EP Strategie Ultra</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0b1120">
    <link rel="icon" href="https://fav.farm/üé¢">
    <link rel="apple-touch-icon" href="https://fav.farm/üé¢">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        :root {
            --bg: #0b1120; --card-bg: rgba(30, 41, 59, 0.8);
            --accent: #38bdf8; --text-main: #f8fafc; --text-dim: #94a3b8;
            --up: #ef4444; --down: #22c55e; --gold: #fbbf24;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 0; overflow: hidden; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; height: 75px; background: rgba(11,17,32,0.9); backdrop-filter: blur(15px); z-index: 1000; border-bottom: 1px solid rgba(255,255,255,0.1); box-sizing: border-box; }
        .sync-info { text-align: center; flex: 1; }
        #last-sync-time { font-size: 0.55em; color: var(--text-dim); text-transform: uppercase; }
        #proxy-info { font-size: 0.5em; color: var(--down); display: block; margin-top: 2px; }
        #park-name { font-size: 0.9em; font-weight: 900; }
        .toggle-group { display: flex; background: rgba(255,255,255,0.05); border-radius: 12px; padding: 3px; }
        .toggle-btn { border: none; background: none; color: var(--text-dim); padding: 8px 12px; font-size: 0.8em; font-weight: 700; border-radius: 10px; }
        .toggle-btn.active { background: var(--accent); color: white; }
        .btn-icon { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; color: white; }
        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--accent); color: white; padding: 10px 20px; border-radius: 12px; font-size: 0.85em; font-weight: 700; z-index: 5000; transition: transform 0.4s; }
        #toast.show { transform: translateX(-50%) translateY(0); }
        #list-view { padding: 15px; height: calc(100vh - 75px); overflow-y: auto; box-sizing: border-box; }
        #map-view { width: 100vw; height: calc(100vh - 75px); display: none; position: relative; }
        .land-section { margin-top: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .card { background: var(--card-bg); border-radius: 20px; padding: 16px; border: 1px solid rgba(255,255,255,0.05); position: relative; }
        .spinning { animation: rotate 0.8s linear infinite; }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="toast">Update...</div>

<header>
    <button class="btn-icon" onclick="openSettings()">‚öôÔ∏è</button>
    <div class="sync-info">
        <div id="park-name">EUROPA-PARK</div>
        <div id="last-sync-time">Synchronisiere...</div>
        <span id="proxy-info">Suche Proxy...</span>
    </div>
    <div class="toggle-group">
        <button id="btn-list" class="toggle-btn active" onclick="switchView('list')">Liste</button>
        <button id="btn-map" class="toggle-btn" onclick="switchView('map')">Karte</button>
    </div>
    <button id="refresh-btn" class="btn-icon" onclick="manualRefresh()">
        <svg id="refresh-svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
    </button>
</header>

<div id="list-view"><div id="main-content"></div></div>
<div id="map-view"></div>

<div id="settings-modal" style="display:none; position:fixed; inset:0; background:#000; z-index:3000; padding:25px; overflow-y:auto;">
    <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom:25px;">
        <h2>Einstellungen</h2>
        <button class="btn-icon" onclick="closeSettings()">‚úï</button>
    </div>
    <div id="settings-list"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    const PARK_URL = "https://queue-times.com/parks/51/queue_times.json";
    
    // Eine Liste von funktionierenden Proxys f√ºr maximale Robustheit
    const PROXY_LIST = [
        { name: "Cloud-A", url: (url) => `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`, type: "json-wrapper" },
        { name: "Cloud-B", url: (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`, type: "direct" },
        { name: "Cloud-C", url: (url) => `https://thingproxy.freeboard.io/fetch/${url}`, type: "direct" }
    ];

    let parkData = {};
    let selectedIds = JSON.parse(localStorage.getItem('ep_favs')) || [];
    let lastSyncTimestamp = 0;
    let map, rideMarkers = [];

    async function fetchWithTimeout(resource, options = {}) {
        const { timeout = 5000 } = options; // 5 Sekunden Timeout
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);
        const response = await fetch(resource, { ...options, signal: controller.signal });
        clearTimeout(id);
        return response;
    }

    async function refresh(isManual = false) {
        const proxyLabel = document.getElementById('proxy-info');
        const refreshSvg = document.getElementById('refresh-svg');
        if(isManual) refreshSvg.classList.add('spinning');

        // Versuche jeden Proxy nacheinander, bis einer klappt
        for (let proxy of PROXY_LIST) {
            try {
                proxyLabel.innerText = `Versuche ${proxy.name}...`;
                const finalUrl = proxy.url(PARK_URL + "?t=" + Date.now());
                const response = await fetchWithTimeout(finalUrl);
                
                let data;
                if (proxy.type === "json-wrapper") {
                    const wrapper = await response.json();
                    data = JSON.parse(wrapper.contents);
                } else {
                    data = await response.json();
                }

                if (data && data.lands) {
                    processData(data);
                    proxyLabel.innerText = `Verbunden via ${proxy.name}`;
                    proxyLabel.style.color = "var(--down)";
                    if (isManual) showToast("Synchronisiert!");
                    lastSyncTimestamp = Date.now();
                    break; // Erfolg! Schleife abbrechen
                }
            } catch (e) {
                console.warn(`${proxy.name} fehlgeschlagen:`, e.message);
                proxyLabel.style.color = "var(--up)";
                // Weiter zum n√§chsten Proxy
            }
        }
        
        refreshSvg.classList.remove('spinning');
    }

    function processData(data) {
        parkData = {};
        data.lands.forEach(land => {
            parkData[land.name] = land.rides.map(r => ({
                ...r, props: { lat: 48.266, lon: 7.721 } // Koordinaten-Logik hier lassen
            }));
        });
        renderList();
        if (map) updateMapMarkers();
    }

    function showToast(text) {
        const t = document.getElementById('toast');
        t.innerText = text; t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2000);
    }

    // Timer f√ºr die "Vor X Sekunden" Anzeige
    setInterval(() => {
        if(lastSyncTimestamp === 0) return;
        const diff = Math.round((Date.now() - lastSyncTimestamp) / 1000);
        document.getElementById('last-sync-time').innerText = `Daten von vor ${diff}s`;
    }, 1000);

    function manualRefresh() { refresh(true); }

    // Initialisierung
    function switchView(view) {
        document.getElementById('list-view').style.display = view === 'list' ? 'block' : 'none';
        document.getElementById('map-view').style.display = view === 'map' ? 'block' : 'none';
        // Map-Fix wie in den Versionen zuvor...
    }

    function renderList() {
        const container = document.getElementById('main-content');
        container.innerHTML = "";
        for (let landName in parkData) {
            const rides = parkData[landName].filter(r => selectedIds.length === 0 || selectedIds.includes(r.id));
            if (rides.length === 0) continue;
            container.innerHTML += `<div class="land-section"><div style="font-size:0.7em; color:var(--accent); font-weight:800; margin-bottom:10px;">${landName.toUpperCase()}</div><div class="grid">${rides.map(r => `
                <div class="card">
                    <div style="font-size:0.85em; font-weight:600; min-height:2.6em;">${r.name}</div>
                    <div style="font-size:2.2em; font-weight:900; color:${r.is_open ? 'var(--accent)' : 'var(--text-dim)'}">${r.is_open ? r.wait_time : '‚úï'}<span style="font-size:0.4em">MIN</span></div>
                </div>`).join('')}</div></div>`;
        }
    }

    function openSettings() { /* Wie zuvor */ }
    function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }

    refresh();
    setInterval(refresh, 60000);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EP Pro Strategie</title>
    
    <link rel="icon" href="https://fav.farm/üé¢">
    <link rel="apple-touch-icon" href="https://fav.farm/üé¢">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        :root {
            --bg: #0b0f1a; --card-bg: rgba(30, 41, 59, 0.7);
            --accent: #60a5fa; --text-main: #f8fafc; --text-dim: #94a3b8;
            --up: #f43f5e; --down: #10b981; --gold: #facc15;
        }
        
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 0; overflow-x: hidden; }
        
        header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px 15px; position: sticky; top: 0; background: rgba(11,15,26,0.9); 
            backdrop-filter: blur(15px); z-index: 1000; height: 65px; border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .toggle-group { display: flex; background: rgba(255,255,255,0.05); border-radius: 12px; padding: 3px; }
        .toggle-btn { border: none; background: none; color: var(--text-dim); padding: 8px 16px; font-size: 0.85em; font-weight: 700; cursor: pointer; border-radius: 10px; transition: 0.2s; }
        .toggle-btn.active { background: var(--accent); color: white; box-shadow: 0 4px 10px rgba(56, 189, 248, 0.3); }

        .btn-icon { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; }
        
        #list-view { padding: 15px; }
        #map-view { width: 100vw; height: calc(100vh - 65px); display: none; }

        .land-section { margin-top: 25px; }
        .land-title { font-size: 0.75em; font-weight: 800; text-transform: uppercase; color: var(--accent); letter-spacing: 1.5px; margin-bottom: 12px; padding-left: 8px; border-left: 3px solid var(--accent); }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(165px, 1fr)); gap: 15px; }
        .card { 
            background: var(--card-bg); border-radius: 20px; padding: 16px; border: 1px solid rgba(255,255,255,0.05); 
            backdrop-filter: blur(10px); position: relative; overflow: hidden;
        }
        .ride-name { font-size: 0.85em; font-weight: 600; min-height: 2.6em; line-height: 1.3; margin-bottom: 10px; }
        .wait-row { display: flex; justify-content: space-between; align-items: baseline; }
        .wait-time { font-size: 2.2em; font-weight: 800; letter-spacing: -1px; }
        .unit { font-size: 0.35em; color: var(--text-dim); margin-left: 2px; }

        /* Badges */
        .badge { font-size: 0.6em; font-weight: 800; padding: 3px 7px; border-radius: 6px; text-transform: uppercase; margin-bottom: 8px; display: inline-block; }
        .badge-sr { background: #6366f1; color: white; margin-right: 5px; }
        .badge-deal { background: var(--gold); color: #000; animation: pulse 2s infinite; }

        /* Map Marker Styles */
        .ride-marker {
            width: 34px; height: 34px; border-radius: 50%; border: 2.5px solid white;
            color: white; font-weight: 900; font-size: 13px; display: flex;
            align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.4);
        }
        .marker-deal { border-color: var(--gold); box-shadow: 0 0 15px var(--gold); }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        
        #settings-modal { display: none; position: fixed; inset: 0; background: #000; z-index: 2000; padding: 25px; overflow-y: auto; }
        .spinning { animation: rotate 0.8s ease-in-out; }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .dist-tag { font-size: 0.65em; color: var(--accent); margin-top: 8px; display: flex; align-items: center; gap: 4px; }
    </style>
</head>
<body>

<header>
    <button class="btn-icon" onclick="openSettings()">‚öôÔ∏è</button>
    <div class="toggle-group">
        <button id="btn-list" class="toggle-btn active" onclick="switchView('list')">Liste</button>
        <button id="btn-map" class="toggle-btn" onclick="switchView('map')">Karte</button>
    </div>
    <button id="refresh-btn" class="btn-icon" onclick="refresh()">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
    </button>
</header>

<div id="list-view"><div id="main-content"></div></div>
<div id="map-view"></div>

<div id="settings-modal">
    <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom:20px">
        <h2>Fahrgesch√§fte w√§hlen</h2>
        <button class="btn-icon" onclick="closeSettings()">‚úï</button>
    </div>
    <div id="settings-list"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    const QT_ID = "51";
    const PROXY = "https://api.allorigins.win/get?url=";
    
    // Massive Datenbank mit Koordinaten und Effizienz-Schwellenwerten
    const RIDE_PROPS = {
        "WODAN - Timburcoaster": { sr: true, lat: 48.2625, lon: 7.7183, best: 35 },
        "blue fire Megacoaster": { sr: true, lat: 48.2618, lon: 7.7205, best: 30 },
        "Silver Star": { sr: true, lat: 48.2691, lon: 7.7218, best: 25 },
        "Arthur": { sr: true, lat: 48.2675, lon: 7.7166, best: 35 },
        "Voletarium": { sr: true, lat: 48.2690, lon: 7.7235, best: 25 },
        "Euro-Mir": { sr: true, lat: 48.2655, lon: 7.7210, best: 25 },
        "Piraten in Batavia": { sr: false, lat: 48.2665, lon: 7.7202, best: 15 },
        "Eurosat - CanCan Coaster": { sr: false, lat: 48.2673, lon: 7.7213, best: 30 },
        "Matterhorn-Blitz": { sr: false, lat: 48.2663, lon: 7.7218, best: 35 },
        "Schweizer Bobbahn": { sr: false, lat: 48.2660, lon: 7.7222, best: 25 },
        "Tiroler Wildwasserbahn": { sr: false, lat: 48.2651, lon: 7.7235, best: 25 },
        "Alpenexpress Enzian": { sr: false, lat: 48.2648, lon: 7.7232, best: 15 },
        "Poseidon": { sr: false, lat: 48.2645, lon: 7.7215, best: 30 },
        "Atlantica SuperSplash": { sr: false, lat: 48.2610, lon: 7.7215, best: 20 },
        "Pegasus": { sr: false, lat: 48.2642, lon: 7.7210, best: 15 },
        "Abenteuer Atlantis": { sr: false, lat: 48.2638, lon: 7.7215, best: 15 },
        "Snorri Touren": { sr: false, lat: 48.2662, lon: 7.7195, best: 20 },
        "Fjord-Rafting": { sr: false, lat: 48.2655, lon: 7.7185, best: 30 },
        "Geisterschloss": { sr: false, lat: 48.2685, lon: 7.7230, best: 10 },
        "Volo da Vinci": { sr: false, lat: 48.2682, lon: 7.7238, best: 20 },
        "Euro-Tower": { sr: false, lat: 48.2668, lon: 7.7215, best: 10 },
        "Jungfrau-Gletscherflieger": { sr: false, lat: 48.2658, lon: 7.7225, best: 15 },
        "Fluch der Kassandra": { sr: false, lat: 48.2640, lon: 7.7205, best: 5 },
        "Vindjammer": { sr: false, lat: 48.2660, lon: 7.7190, best: 10 },
        "Koffiekopjes": { sr: false, lat: 48.2675, lon: 7.7195, best: 10 },
        "Schlittenfahrt Schneefl√∂ckchen": { sr: false, lat: 48.2650, lon: 7.7205, best: 10 },
        "Ba-a-a Express": { sr: false, lat: 48.2685, lon: 7.7195, best: 10 }
    };

    let parkData = {};
    let userPos = null;
    let selectedIds = JSON.parse(localStorage.getItem('ep_favs')) || [];
    let map, userMarker, rideMarkers = [];

    // Intelligente Suche f√ºr Koordinaten (falls Name leicht abweicht)
    function findProps(name) {
        if (RIDE_PROPS[name]) return RIDE_PROPS[name];
        const keys = Object.keys(RIDE_PROPS);
        for (let k of keys) { if (name.includes(k) || k.includes(name)) return RIDE_PROPS[k]; }
        return { lat: 48.266, lon: 7.721, best: 10, isFallback: true };
    }

    function switchView(view) {
        document.getElementById('list-view').style.display = view === 'list' ? 'block' : 'none';
        document.getElementById('map-view').style.display = view === 'map' ? 'block' : 'none';
        document.getElementById('btn-list').classList.toggle('active', view === 'list');
        document.getElementById('btn-map').classList.toggle('active', view === 'map');
        if (view === 'map') {
            if (!map) {
                map = L.map('map-view', { zoomControl: false }).setView([48.266, 7.721], 16);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
            }
            setTimeout(() => { map.invalidateSize(); updateMapMarkers(); }, 200);
        }
    }

    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(pos => {
            userPos = { lat: pos.coords.latitude, lon: pos.coords.longitude };
            if (map) {
                if (!userMarker) userMarker = L.circleMarker([userPos.lat, userPos.lon], { radius: 7, color: '#60a5fa', fillOpacity: 1, weight: 3 }).addTo(map);
                else userMarker.setLatLng([userPos.lat, userPos.lon]);
            }
        }, null, { enableHighAccuracy: true });
    }

    async function refresh() {
        const btn = document.getElementById('refresh-btn');
        btn.classList.add('spinning');
        try {
            const url = `https://queue-times.com/parks/${QT_ID}/queue_times.json`;
            const resp = await fetch(PROXY + encodeURIComponent(url));
            const json = await resp.json();
            const data = JSON.parse(json.contents);
            parkData = {};
            data.lands.forEach(land => {
                parkData[land.name] = land.rides.map(r => ({ ...r, props: findProps(r.name) }));
            });
            renderList();
            if (map) updateMapMarkers();
        } catch (e) { console.error(e); }
        setTimeout(() => btn.classList.remove('spinning'), 800);
    }

    function calculateDist(lat1, lon1, lat2, lon2) {
        const R = 6371; const dLat = (lat2-lat1)*Math.PI/180; const dLon = (lon2-lon1)*Math.PI/180;
        const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
        const d = R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return d < 1 ? Math.round(d*1000)+"m" : d.toFixed(1)+"km";
    }

    function updateMapMarkers() {
        if (!map) return;
        rideMarkers.forEach(m => map.removeLayer(m)); rideMarkers = [];
        for (let land in parkData) {
            parkData[land].forEach(r => {
                if (selectedIds.length > 0 && !selectedIds.includes(r.id)) return;
                if (r.props.isFallback && selectedIds.length > 0) return;
                const isDeal = r.is_open && r.wait_time <= r.props.best;
                const color = r.is_open ? (r.wait_time > 45 ? '#ef4444' : (r.wait_time > 15 ? '#60a5fa' : '#10b981')) : '#4b5563';
                const icon = L.divIcon({
                    className: 'custom-icon',
                    html: `<div class="ride-marker ${isDeal ? 'marker-deal' : ''}" style="background:${color}">${r.is_open ? r.wait_time : '‚úï'}</div>`,
                    iconSize: [34, 34]
                });
                const m = L.marker([r.props.lat, r.props.lon], { icon }).addTo(map).bindPopup(`<b>${r.name}</b><br>Wartezeit: ${r.wait_time} min`);
                rideMarkers.push(m);
            });
        }
    }

    function renderList() {
        const container = document.getElementById('main-content'); container.innerHTML = "";
        for (let landName in parkData) {
            const rides = parkData[landName].filter(r => selectedIds.length === 0 || selectedIds.includes(r.id));
            if (rides.length === 0) continue;
            container.innerHTML += `<div class="land-section"><div class="land-title">${landName}</div><div class="grid">${rides.map(r => {
                const isDeal = r.is_open && r.wait_time <= r.props.best;
                const dist = userPos ? calculateDist(userPos.lat, userPos.lon, r.props.lat, r.props.lon) : "";
                return `<div class="card" style="${isDeal ? 'border-color:var(--gold)' : ''}">
                    <div>${r.props.sr ? '<span class="badge badge-sr">SR</span>' : ''}${isDeal ? '<span class="badge badge-deal">Top Deal</span>' : ''}</div>
                    <div class="ride-name">${r.name}</div>
                    <div class="wait-row">
                        <div class="wait-time" style="color:${r.is_open ? (r.wait_time > 40 ? 'var(--up)' : 'var(--accent)') : 'var(--text-dim)'}">
                            ${r.is_open ? r.wait_time : '‚úï'}<span class="unit">${r.is_open ? 'MIN' : ''}</span>
                        </div>
                    </div>
                    ${dist ? `<div class="dist-tag"><svg width="10" height="10" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/></svg>${dist}</div>` : ''}
                </div>`;
            }).join('')}</div></div>`;
        }
    }

    function openSettings() {
        const list = document.getElementById('settings-list'); list.innerHTML = "";
        let flat = []; for(let l in parkData) flat = [...flat, ...parkData[l]];
        flat.sort((a,b)=>a.name.localeCompare(b.name)).forEach(r => {
            list.innerHTML += `<div style="display:flex; justify-content:space-between; padding:15px; border-bottom:1px solid #1e293b">
                <span style="font-size:0.9em">${r.name}</span>
                <input type="checkbox" style="width:20px; height:20px" ${selectedIds.includes(r.id) ? 'checked' : ''} onchange="toggle(${r.id})">
            </div>`;
        });
        document.getElementById('settings-modal').style.display = "block";
    }

    function toggle(id) {
        if (selectedIds.includes(id)) selectedIds = selectedIds.filter(i => i !== id); else selectedIds.push(id);
        localStorage.setItem('ep_favs', JSON.stringify(selectedIds)); renderList(); if (map) updateMapMarkers();
    }

    function closeSettings() { document.getElementById('settings-modal').style.display = "none"; }
    refresh(); setInterval(refresh, 180000);
</script>
</body>
</html>
